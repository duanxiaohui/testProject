<!DOCTYPE html>
<html>
 <head>
	<title>365幸运大转盘</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="http://www.365rili.com/pages/bd/lottery_365spring/css/base.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
    .bar{height:43px; line-height:43px; text-align:center; background:#fff; font-size:20px; color:#000;}
    .share_btn{width:20px; height:20px; position: absolute; top:11px; right:15px; background:url(http://www.365rili.com/pages/forum/images/share_btn.png) no-repeat; background-size:100% 100%;} 
    .weixin .bar{display:none;}
    </style>
 </head>
<body>
    <div class="bar">
        <a href="javascript:;" class="share_btn"></a>
        <div class="bar_txt">365幸运大转盘</div>
    </div>
    <div class="rullContent"></div>
	<div class="main">
		<div class="content">
			<div class="lottery">
                <div class="circle"></div>
                <div class="start"></div>
                <div class="pointer none"></div>
			</div>
            
            <div class="lottery_txt"></div>
            <span class="rull">兑换须知>></span>
		</div>
	</div>
    <div class="lottery_info none">
        <div class="prize">
            <div class="prize_pic">
                <img src="images/prize.jpg"/>
            </div>
            <div class="prize_txt">
                您的奖品是<br/>50元手机充值卡
            </div>
        </div>
        <div class="lottery_info_txt">
            <h3>获奖人信息</h3>
            <!--<input type="text" class="username" placeholder="姓名"/>-->
            <input type="text" class="mobile" placeholder="手机号"/>
            <!--<input type="text" class="address" placeholder="邮寄地址"/>-->
        </div>
        <div class="lottery_note">
            <p>注：请务必填写详细正确信息。<br/>以便工作人员与您取得联系，并送出奖品。</p>
            <a href="javascript:;" class="submit_btn">提交信息</a>
        </div>
    </div>
    <div class="infosub_layer none">
        <!-- <p>请耐心等待我们联络您中奖事宜<br/>中奖名单将在<br/>@365日历 官方微博公布</p> -->
    </div>
    <div class="confirm_info_layer none">
        <h3>确认获奖人信息</h3>
        <div class="confirm_info_txt">
            <!--<p>姓名 <span class="confirm_name"></span></p>-->
            <p>手机号 <span class="confirm_mobile"></span></p>
            <!--<p>地址 <span class="confirm_address"></span></p>-->
        </div>
        <div class="confirm_info_btn">
            <a href="javascript:;" class="edit_btn">重新编辑</a><a href="javascript:;" class="confirm_btn">确认</a>
        </div>
    </div>
    <input id="UID" type="hidden" >
    <input id="PWD" type="hidden" >
    <input id="MAC" type="hidden" >
    <input id="VER" type="hidden" >
<script src="/js/jquery/jquery-1.8.3.min.js"></script>
<script src="/js/jquery/jquery-ui-1.9.0.custom.min.js"></script>
<script src="/js/jquery/jquery.cookie.js"></script>
<script src="/js/jquery/jquery.rotate.js"></script>
<script src='http://res.wx.qq.com/open/js/jweixin-1.0.0.js'></script>
<script src="/share/js/weixin_1.0.js"></script>
<script src="/js/lib/app.js"></script>
<script>
    var lottery = {
        config: {
            w: $(window).width(),
            h: $(window).height(),
            key: '',
            date: null,
            dateStr: '',
            UID: '0',
            MAC: 'null'
        },

        init: function() {
            $(".lottery_info, .infosub_layer, .confirm_info_layer").width(lottery.config.w).height(lottery.config.h);
            $('.circle').css('transform', 'rotate(60deg)');
        },

        bindEvents: function() {
            $('.rullContent').on('click', function () {
                $(this).fadeOut('fast');
            })
            $('.rull').on('click', function () {
                $('.rullContent').fadeIn('fast');
            })
            $('.start').on('click', function() {
                if($.cookie('flag') == lottery.config.dateStr) {
                    alert('每天只有一次抽奖机会，明天再来吧！');
                    return;
                }
                lottery.getLottery();
            });

            $('.submit_btn').on('click', function() {
                var mobile = $('.mobile').val();
                if(mobile == '') {
                    alert('请填写完整的信息以便领取奖品。');
                    $('body').scrollTop(0);
                    return;
                }
                if(!(/^1[3|4|5|8][0-9]\d{4,8}$/.test(mobile))) {
                    alert('请输入正确格式的手机号码！');
                    $('body').scrollTop(0);
                    return;
                }
                $('.lottery_info').addClass('none');
                $('.confirm_info_layer').removeClass('none');
                $('.confirm_mobile').text(mobile);
            });

            $('.edit_btn').on('click', function() {
                $('.confirm_info_layer').addClass('none');
                $('.lottery_info').removeClass('none');
            });

            $('.confirm_btn').click(function() {
                lottery.lotteryUser();
            });
        },

        getUserInfo: function() {
            try {
                if(/android/i.test(navigator.userAgent)) {
                    lottery.config.UID = AliansBridge.getUserId();
                    lottery.config.MAC = AliansBridge.getMac();
                } else {
                    setTimeout(function() {
                        lottery.config.UID = document.getElementById('UID').value;
                        lottery.config.MAC = document.getElementById('MAC').value;
                    }, 500);
                }
            } catch(e) {
                lottery.config.UID = 0;
                lottery.config.MAC = 0;
            }
        },

        getLottery: function() {
            if(lottery.config.UID == '') {
                lottery.config.UID = 0;
            }
            if(lottery.config.MAC == '') {
                lottery.config.MAC = 0;
            }
            $.ajax({
                url: '/coop/lottery.do',
                type: 'post',
                dataType: 'json',
                data: {
                    deviceID: lottery.config.MAC,
                    userID: lottery.config.UID,
                    campaign:'spring'
                },
                success: function(data) {
                    lottery.handleLottery(data);
                }
            });
        },

        handleLottery: function(data) {
            if(data.prize == -1) {
                alert('来晚啦~礼物都送完啦亲！下次早点来！');
                return;
            }
            else if(data.prize == 0){
                alert('真可惜，只差一点点...');
                return;
            }
            else{
                $('.pointer').removeClass('none');
            }
            if(data.prize > 0) {
                lottery.config.key = data.key;
            }
            var prize = data.prize,
                rotate = 60 + 10 * 360;
            if(prize == 0) {
            } else if(prize == 1) {
                rotate = 360 * 10 + 360;
                $('.prize_txt').html('您的奖品是<br/>爱拼车代金券');
                $('.prize_pic img').attr('src', 'images/prize.jpg');
                $('.lottery_info_txt').html('\
                    <h3 style="margin-left:15px;">点击领取爱拼车10元代金券</h3>\
                ');
                $('.lottery_note').html('\
                    <div class="lottery_note" style="margin-top:10px;">\
                        <a href="http://lottery.apinche.com/365cal/index.html" class="submit_btn">点击领取</a>\
                    </div>\
                ');
                $('.submit_btn').off('click');
            } else if(prize == 3) {
                rotate = 360 * 10 + 300;
                $('.prize_txt').html('您的奖品是<br/>百姓彩票5元现金兑换码');
                $('.prize_pic img').attr('src', 'images/prize2.jpg');
            } else if(prize == 5) {
                rotate = 360 * 10 + 240;
                $('.prize_txt').html('您的奖品是<br/>宝驾租车200元红包');
                $('.prize_pic img').attr('src', 'images/prize3.jpg');
            } else if(prize == 2) {
                rotate = 360 * 10 + 180;
                $('.prize_txt').html('您的奖品是<br/>友友租车现金券');
                $('.prize_pic img').attr('src', 'images/prize4.jpg');
                $('.lottery_info_txt').html('\
                    <h3 style="margin-left:15px;">点击领取友友租车100元现金券</h3>\
                ');
                $('.lottery_note').html('\
                    <div class="lottery_note" style="margin-top:10px;">\
                        <a href="http://reg.uuzuche.com/wap_reg.php?tpl=nkcwmd&channel_from=365rili" class="submit_btn">点击领取</a>\
                    </div>\
                ');
            } else if(prize == 6) {
                rotate = 360 * 10 + 120;
                $('.prize_txt').html('您的奖品是<br/>袋洗20元现金兑换码');
                $('.prize_pic img').attr('src', 'images/prize5.jpg');
            } else if(prize == 4) {
                rotate = 360 * 10 + 60;
                $('.prize_txt').html('您的奖品是<br/>爱大厨69元现金券');
                $('.prize_pic img').attr('src', 'images/prize6.jpg');
            }
            $(".circle").rotate({
                angle: 0,
                animateTo: rotate,
                duration: 10000,
                callback: function() {
                    if(data.prize == 0) {
                        alert('真可惜，只差一点点...');
                    } else {
                        alert('恭喜你！中奖啦！');
                        $('.main').addClass('none');
                        $('.lottery_info').removeClass('none');
                    }
                }
            });
            $.cookie('flag', lottery.config.dateStr, {expires: 365});
        },

        lotteryUser: function() {
            $.ajax({
                url: '/coop/lottery_user.do',
                type: 'post',
                dataType: 'json',
                data: {
                    phone: $('.confirm_mobile').text(),
                    key: lottery.config.key,
                    campaign:'spring'
                },
                success: function(data) {
                    if(data.state == 'ok') {
                        alert('提交成功!');
                        $('.confirm_info_layer').addClass('none');
                        $('.infosub_layer').removeClass('none');
                    }
                }
            });
        }
    };
    if(app.getUa.weixin){
        $('body').addClass('weixin');
        wxProtocol.init({
            imgUrl: 'http://www.365rili.com/images/114.jpg',
            title: '年货大集，全场免单  365日历福利送到家！',
            desc: '免费租车，免费厨师，免费洗衣，手气够好还有500万等你拿！'
        });
    }
    else{
        if(app.getUa.ios){
            var sUserAgent = navigator.userAgent.toLowerCase();
            var len = sUserAgent.length,
                index = sUserAgent.indexOf('ios-coco');
            if(index > -1) {
                var s = sUserAgent.substring(index, len),
                    arr = s.split('|');
                var version = 0;
                $.each(arr, function(k, v) {
                    if(/5\./i.test(v)) {
                        version = parseFloat(v);
                        return
                    }
                });
                if(version < 5.3) {
                    $('.share_btn').hide();
                }
            }
        }
        $('.share_btn').on('click', function(){
            app.call({
                action: 'share',
                params: [
                    {
                        name: 'shareString',
                        value: JSON.stringify({
                            title: '年货大集，全场免单  365日历福利送到家！',
                            content: '免费租车，免费厨师，免费洗衣，手气够好还有500万等你拿！',
                            link: window.location.href,
                            image: 'http://www.365rili.com/images/114.jpg',
                            isEvent: 'true'
                        })
                    }
                ],
                callback: function(data) {}
            });
        });
    }
    $(document).ready(function() {
        var date = new Date(),
            dateStr = date.getFullYear() + '-' + (date.getMonth()+1) + '-' + date.getDate();
        lottery.config.date = date;
        lottery.config.dateStr = dateStr;
        lottery.init();
        lottery.getUserInfo();
        lottery.bindEvents();
    });
</script>
</body>
</html>