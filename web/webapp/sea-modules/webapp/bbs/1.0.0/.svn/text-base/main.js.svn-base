define("webapp/bbs/1.0.0/main",["./subjectListView","./data","./util","./commentListView","./subjectCreateView","./messageListView"],function(a,b,c){function d(a){if("subject_list"==a)e.init(f,h);else if("comment_list"==a)if(location.href.indexOf("uuid")>0){f.init(!0);var b=g.getURLParameter("uuid");f.render(b)}else{f.init(!1);var c=g.getURLParameter("tid");f.render(c)}else"subject_create"==a?h.init():"message_list"==a&&i.init()}var e=a("./subjectListView"),f=a("./commentListView"),g=a("./util"),h=a("./subjectCreateView"),i=a("./messageListView");c.exports={init:d},document.addEventListener("touchstart",function(){},!1)}),define("webapp/bbs/1.0.0/subjectListView",["webapp/bbs/1.0.0/data","webapp/bbs/1.0.0/util"],function(a,b,c){function d(a){var b='<li class="subject_header e_clear"><div class="cal_img_border"><div class="cal_img"><img src="{thumb}" /></div></div><div class="cal_info"><h3>{title}</h3><p>话题：{topicCount}</p></div></li>';n.ulList.append(m(b,a)),$(".header_title").html(a.title)}function e(a){var b='<li class="subject_item" tid="{id}"><h3><span class="top {top}">置顶</span><span class="notice {notice}">公告</span><span class="excellent {excellent}">精华</span>{title}</h3><p>{body}</p><div class="subject_list_bottom e_clear"><span class="re_time">{timeStr}</span><span class="com_num">{replyCount}</span><span class="author">{username}</span></div><div class="{admin}"><button class="manage_action {no_top}" val="3">置顶</button><button class="manage_action {top}" val="6">取消置顶</button><button class="manage_action {no_notice}" val="2">公告</button><button class="manage_action {notice}" val="5">取消公告</button><button class="manage_action {no_excellent}" val="1">精华</button><button class="manage_action {excellent}" val="4">取消精华</button></div></li>',c=$(m(b,a));c.click(function(){var a=$(this).attr("tid");n.scrollTop=document.body.scrollTop,j(!1,n.clView.container),location.href="#clView="+a,n.clView.render(a,!0)}),c.find(".manage_action").click(function(a){a.stopPropagation(),a.preventDefault();var b=$(this).parent().parent(),c=b.attr("tid"),d=$(this).attr("val");k.manageTopic(c,d,function(){f()})}),n.ulList.append(c)}function f(){$(".more_btn_wrapper").hide(),$(".create_btn_wrapper").hide(),k.initSubject(function(a,b){n.ulList.empty(),o=0,d(a),e(b),b.length>=k.subjectPageCount?$(".more_btn_wrapper").show():n.ulList.css("margin-bottom","60px"),$("#subject_loadmore_btn").html("更多"),$(".create_btn_wrapper").show()})}function g(a){k.getSubjectList(++o,function(b){e(b),a.html("更多"),a.removeClass("loading"),0==b.length&&a.html("没有更多内容啦")})}function h(a,b){if(n.clView=a,n.scView=b,n.clView.init(!1),n.scView.init(),location.hash.indexOf("scView")>-1)j(!1),n.scView.render();else if(location.hash.indexOf("clView")>-1){var c=location.hash.split("=")[1];j(!1),n.clView.render(c)}else i(!0);$("#subject_loadmore_btn").click(function(){var a=$(this);a.hasClass("loading")||(a.html("加载更多..."),a.addClass("loading"),g(a))}),n.createBtn.click(function(){j(!1,n.scView.container),location.href="#scView",n.scView.render()}),n.refreshBtn.click(function(){f()}),window.addEventListener("hashchange",function(a){-1==a.newURL.indexOf("#")&&(a.oldURL.indexOf("#scView")>-1?(n.scView.dealloc(!1,n.container),i(!0)):(n.clView.dealloc(!1,n.container),i(!0)))},!1),n.container.css("min-height",$(window).height()+"px")}function i(a){a&&f(),n.container.show(),n.backBtn.css("display","block"),n.createBtn.css("display","block"),n.refreshBtn.css("display","block"),n.scrollTop&&(document.body.scrollTop=n.scrollTop)}function j(a,b){a?l.animate(n.container,"left",b):($("body").scrollTop(0),n.container.hide()),n.backBtn.hide(),n.createBtn.hide(),n.refreshBtn.hide()}var k=a("webapp/bbs/1.0.0/data"),l=a("webapp/bbs/1.0.0/util"),m=l.format,n={};n.container=$(".subject_list_view"),n.ulList=$("#subject_list_ul"),n.backBtn=$("#subject_back_btn"),n.createBtn=$("#create_subject_btn"),n.refreshBtn=$("#subject_refresh_btn");var o=0;c.exports={init:h}}),define("webapp/bbs/1.0.0/data",["webapp/bbs/1.0.0/util"],function(a,b,c){function d(a){var b=(new Date).getTime()-a,c=new Date(a),d=z.getDateZero(new Date).getTime()-z.getDateZero(c).getTime();return 6e4>b?"刚刚":b>=6e4&&36e5>b?Math.floor(b/6e4)+"分钟前":b>=36e5&&864e5>d?[("0"+c.getHours()).slice(-2),("0"+c.getMinutes()).slice(-2)].join(":"):d>=864e5&&2592e6>d?Math.floor(d/864e5)+"天前":[c.getFullYear(),("0"+(c.getMonth()+1)).slice(-2),("0"+c.getDate()).slice(-2)].join("-")}function e(a){0==a.type?(a.excellent="hide",a.no_excellent="show"):(a.excellent="show",a.no_excellent="hide"),0==a.state?(a.top="hide",a.notice="hide",a.no_top="show",a.no_notice="show"):1==a.state?(a.top="show",a.notice="hide",a.no_top="hide",a.no_notice="show"):(a.top="hide",a.notice="show",a.no_top="show",a.no_notice="hide"),a.title=z.encodeHtml(a.title),a.body=z.encodeHtml(a.body)}function f(a){return $.map(a,function(a){return 0==a.scheduleID?a.body.length>50&&(a.body=a.body.substr(0,50)+"..."):a.body="",e(a),a.timeStr=d(a.lastReplyTime),a.admin="true"==D?"show":"hide",a})}function g(a){return a?$.map(a,function(a){return a.timeStr=d(a.created),a.lz=a.userID==E.userID?"show":"hide",a.floor=++F,-1!=a.reply_user_id&&(a.replyUsername="回复 "+a.replyUsername+"："),a.deleteClass=a.userID==v||"true"==D?"show":"hide",a.content=z.encodeHtml(a.content),a}):[]}function h(a){$.ajax({url:B+"/bbs365/getTopicList.do?calendarID="+t+"&pageNum=0&pageCount="+A.subjectPageCount+"&token="+u+"&nocache="+C+y,type:"get",dataType:"json",success:function(b){a(b)}})}function i(a,b){$.ajax({url:"/bbs365/getMoreTopics.do?calendarID="+t+"&pageNum="+a+"&pageCount="+A.subjectPageCount+"&token="+u+"&nocache="+C+y,type:"get",dataType:"json",success:function(a){b(a)}})}function j(a,b){$.ajax({url:B+"/bbs365/getReplyList.do?topicID="+a+"&pageNum=0&pageCount="+A.commentPageCount+"&token="+u+"&nocache="+C+y,type:"get",dataType:"json",success:function(a){b(a)}})}function k(a,b,c){$.ajax({url:B+"/bbs365/getMoreReplies.do?topicID="+a+"&pageNum="+b+"&pageCount="+A.commentPageCount+"&token="+u+"&nocache="+C+y,type:"get",dataType:"json",success:function(a){c(a)}})}function l(a,b){$.ajax({url:B+"/bbs365/getTopicBySchedule.do?calendarID="+t+"&uuid="+a+"&pageNum=0&pageCount="+A.commentPageCount+"&token="+u+"&nocache="+C+y,type:"get",dataType:"json",success:function(a){b(a)}})}function m(a,b,c){$.ajax({url:B+"/bbs365/postTopic.do",type:"post",dataType:"json",data:{calendarID:t,title:a,body:b,token:u,"coco-ua":x},success:function(a){c(a)}})}function n(a,b,c,d,e){$.ajax({url:B+"/bbs365/postReply.do",type:"post",dataType:"json",data:{replyUserID:a,content:b,topicID:c,token:u,"coco-ua":x},success:function(a){d(a)},error:e,timeout:1e4})}function o(a,b,c,d,e){$.ajax({url:B+"/bbs365/postReplyBySchedule.do",type:"post",dataType:"json",data:{replyUserID:a,content:b,uuid:c,token:u,calendarID:t,"coco-ua":x},success:function(a){d(a)},error:e,timeout:1e4})}function p(a,b){$.ajax({url:B+"/bbs365/deleteTopic.do?topicID="+a+"&token="+u+y,type:"get",dataType:"json",success:function(a){b(a)}})}function q(a,b){$.ajax({url:B+"/bbs365/deleteReply.do?replyID="+a+"&token="+u+y,type:"get",dataType:"json",success:function(a){b(a)}})}function r(a,b,c){$.ajax({url:B+"/bbs365/topicAdmin.do?topicID="+a+"&action="+b+"&token="+u+y,type:"get",dataType:"json",success:function(a){c(a)}})}function s(a,b){$.ajax({url:B+"/bbs365/getMyReplies.do?pageNum="+a+"&pageCount="+A.commentPageCount+"&token="+u+"&nocache="+C+y,type:"get",dataType:"json",success:function(a){b(a)}})}var t,u,v,w,x,y,z=a("webapp/bbs/1.0.0/util"),A={},B="",C=(new Date).getTime(),D=z.getURLParameter("admin");"true"==D&&($(".comment_btn_wrapper").show(),$(".comment_back_btn").click(function(){history.back()})),location.href.indexOf("?dev")>0?(t="427",u="MjQ2OjExMTExMQ==",v="246",w=(new Date).getTime()):(t=z.getURLParameter("cid"),u=z.getURLParameter("t"),v=z.getURLParameter("uid"),w=z.getURLParameter("i"),location.href.indexOf("coco-ua")>0?(x=z.getURLParameter("coco-ua"),y="&coco-ua="+x):(x="",y="")),A.subjectPageCount=20,A.commentPageCount=100;var E={},F=1;A.initSubject=function(a){h(function(b){"ok"==b.state&&a(b.calendarInfo,f(b.specialTopics.concat(b.topics)))})},A.getSubjectList=function(a,b){i(a,function(a){"ok"==a.state&&b(f(a.topics))})},A.addSubject=function(a,b){$("#loading_wrapper").show();var c=(new Date).getTime();m(a.title,a.body,function(a){if("ok"==a.state){var d=(new Date).getTime()-c;1e3>d?setTimeout(function(){$("#loading_wrapper").hide(),b(a)},1e3-d):($("#loading_wrapper").hide(),b(a))}})},A.deleteSubject=function(a,b){p(a,function(a){"ok"==a.state&&b(a)})},A.initComment=function(a,b,c,d){var f=j;c&&(f=l),f(a,function(a){"ok"==a.state?(E=a.topic,a.topic.timeStr=z.formatDate(a.topic.created),F=1,a.topic.floor=F,a.topic.replyCount++,a.topic.deleteClass=a.topic.userID==v&&-1!=a.topic.id||"true"==D?"show":"hide",e(a.topic),b(a.topic,g(a.replyList),a.piclist)):"failed"==a.state&&d()})},A.getCommentList=function(a,b,c){k(a,b,function(a){c(g(a.replyList))})},A.addComment=function(a,b,c){var d=n;c&&(d=o),$("#loading_wrapper").show();var e=(new Date).getTime();d(a.userID,a.content,a.topicID,function(a){if("ok"==a.state){var c=(new Date).getTime()-e;1e3>c?setTimeout(function(){$("#loading_wrapper").hide(),b(g([a.reply]))},1e3-c):($("#loading_wrapper").hide(),b(g([a.reply])))}},function(){$("#loading_wrapper").html("<div class='loading_error'>回复失败，请刷新后重试</div>")})},A.deleteComment=function(a,b){q(a,function(a){"ok"==a.state&&b(a)})},A.manageTopic=function(a,b,c){r(a,b,function(a){"ok"==a.state&&c(a)})},A.getMessageList=function(a,b){s(a,function(a){b($.map(a,function(a){return a.timeStr=z.formatDate(a.created),a}))})},A.getParams=function(){return["?cid=",t,"&uid=",v,"&t=",u,"&i=",w,y].join("")},c.exports=A}),define("webapp/bbs/1.0.0/util",[],function(a,b,c){var d,e={};c.exports=e,e.format=function(){var a=$.makeArray(arguments),b=String(a.shift()||""),c=[],e=a[0];return a=$.isArray(e)?e:"object"==typeof e?a:[a],$.each(a,function(a,e){c.push(b.replace(d||(d=/\{([\d\w\.]+)\}/g),function(b,c,d){return d="INDEX"===c?a:c.indexOf(".")<0?e[c]:$.route(e,c),void 0===d?b:$.isFunction(d)?d.call(e,c):d}))}),c.join("")},e.formatDate=function(a){var b=new Date(a),c=[b.getFullYear(),("0"+(b.getMonth()+1)).slice(-2),("0"+b.getDate()).slice(-2)].join("-"),d=[("0"+b.getHours()).slice(-2),("0"+b.getMinutes()).slice(-2)].join(":");return c+" "+d},e.bIsAndroid=function(){var a=navigator.userAgent.toLowerCase();return"android"==a.match(/android/i)},e.getURLParameter=function(a){return decodeURIComponent((new RegExp("[?|&]"+a+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},e.getDateZero=function(a){var b=new Date(a);return b.setHours(0),b.setMinutes(0),b.setSeconds(0),b.setMilliseconds(0),b},e.encodeHtml=function(a){var b="";return 0==a.length?"":(b=a.replace(/&/g,"&amp;"),b=b.replace(/</g,"&lt;"),b=b.replace(/>/g,"&gt;"),b=b.replace(/ /g,"&nbsp;"),b=b.replace(/\'/g,"&#39;"),b=b.replace(/\"/g,"&quot;"),b=b.replace(/\n/g,"<br>"))},e.animate=function(a,b){var c=$(window).width();$("body").scrollTop(0),a.css("z-index","11"),a.one("webkitTransitionEnd",function(){$(this).hide(),$(this).css("left","0px"),$(this).css("z-index","1")}),"left"==b?a.css("left","-"+c+"px"):a.css("left",c+"px")}}),define("webapp/bbs/1.0.0/commentListView",["webapp/bbs/1.0.0/data","webapp/bbs/1.0.0/util"],function(a,b,c){function d(a,b){k.scheduleTopicID=a.id;var c='<li class="comment_header"><h3>{title}</h3><p>{body}</p><div class="image_container"></div><div class="comment_header_bottom"><a href="javascript:;" class="delete_subject_btn {deleteClass}" tid={id}>删除</a><span class="author">{username}</span><span class="re_time">{timeStr}</span><p class="reply_num">共{replyCount}楼</p></div><div class="floor">{floor}楼</div></li>';if(k.ulList.append(j(c,a)),k.ulList.find(".delete_subject_btn").click(function(){var a=confirm("确定删除您所发表的主题？");a&&h.deleteSubject($(this).attr("tid"),function(){k.bSchedule?f():k.parentRender(!0)})}),b)for(var d in b)k.ulList.find(".image_container").append("<div class='image_div'><img src='"+b[d]+"' class='image_item'/></div>")}function e(a,b){var c='<li class="comment_item comment_item_{id}"><div class="comment_username"><span class="louzhu hide">楼主</span>{username} :</div><div class="comment_txt">{replyUsername}{content}</div><div class="comment_item_bottom"><span>{timeStr}</span><a href="javascript:;" class="delete_comment_btn {deleteClass}" rid={id}>删除</a><a href="javascript:;" class="reply_btn" userid={userID} username={username} >回复</a></div><div class="floor">{floor}楼</div></li>',d=$(j(c,a));b&&d.css("background","#fffcd7"),d.find(".delete_comment_btn").click(function(){var a=confirm("是否删除您的评论");if(a){var b=$(this).attr("rid");h.deleteComment(b,function(){k.ulList.find(".comment_item_"+b).remove()})}}),d.find(".reply_btn").click(function(){var a=$(this),b=a.parent().parent();if(b.find(".reply_comment_div").length>0)b.find(".reply_comment_div").remove(),a.html("回复");else{$(".comment_item .reply_btn").html("回复"),$(".comment_item .reply_comment_div").remove();var c=a.attr("userid"),d=a.attr("username");a.html("取消回复"),b.append("<div class='reply_comment_div'><div class='reply_input_div'><textarea type='text' class='reply_input' placeholder='回复 "+d+"'></textarea></div><a class='reply_send' href='javascript:;'>回复</a></div>"),b.find(".reply_send").click(function(){var d=$(this).parent().find(".reply_input").val().trim();if(0==d.length)return alert("回复不能为空"),void 0;if(d.length>1024)return alert("回复内容超出限制"),void 0;var f=$(this);$(this).hasClass("progress")||($(this).addClass("progress"),h.addComment({userID:c,content:d,topicID:k.topicID},function(c){f.removeClass("progress"),m=!0,b.find(".reply_comment_div").remove(),a.html("回复"),e(c,!0)},k.bSchedule))})}}),k.ulList.append(d)}function f(){$(".comment_edit_area").hide(),$(".comment_loadmore").hide(),k.ulList.html('<li class="preload_item" style="background: #ecedee;border:none;margin:200px auto;"><div class="loadbar"></div><div class="loadbar"></div><div class="loadbar"></div></li>'),h.initComment(k.topicID,function(a,b,c){k.ulList.empty(),l=0,k.bSchedule||d(a,c),e(b),b.length>=h.commentPageCount&&$(".comment_loadmore").show(),$("#comment_loadmore_btn").html("更多"),$(".comment_edit_area").show(),document.body.scrollHeight>screen.height?$(".comment_back_btn").show():$(".comment_back_btn").hide()},k.bSchedule,function(){k.ulList.html('<li style="text-align:center;height:100px;line-height:100px;">抱歉，此消息已被作者删除</li>')})}function g(a){var b=k.topicID;return k.bSchedule&&(b=k.scheduleTopicID),-1==b?(f(),void 0):(h.getCommentList(b,++l,function(b){e(b),a.html("更多"),a.removeClass("loading"),0==b.length&&a.html("没有更多内容啦")}),void 0)}var h=a("webapp/bbs/1.0.0/data"),i=a("webapp/bbs/1.0.0/util"),j=i.format,k={},l=0;k.ulList=$("#comment_list_ul"),k.container=$(".comment_list_view");var m=!1;k.init=function(a){k.parentRender=function(){history.back()},k.bSchedule=a,$("#send_comment").click(function(){var b=$("#comment_input").val().trim();return 0==b.length?(alert("评论不能为空"),void 0):b.length>1024?(alert("评论内容超出限制"),void 0):($(this).hasClass("progress")||($(this).addClass("progress"),h.addComment({userID:"-1",content:b,topicID:k.topicID},function(a){$("#send_comment").removeClass("progress"),m=!0,$("#comment_input").val(""),e(a,!0)},a)),void 0)}),$("#comment_loadmore_btn").click(function(){var a=$(this);a.hasClass("loading")||(a.html("加载更多..."),a.addClass("loading"),g(a))}),k.container.css("min-height",$(window).height()+"px"),$(".comment_back_btn").click(function(){$(this).hide(),$("#comment_input").focus()}),$(window).scroll(function(){$(window).scrollTop()+$(window).height()>=$(document).height()?$(".comment_back_btn").hide():0==$(window).scrollTop()&&$(".comment_back_btn").show()})},k.render=function(a){k.topicID=a,m=!1,f(),k.container.show(),location.href.indexOf("focus")>0&&setTimeout(function(){$("#comment_input").focus()},500)},k.dealloc=function(a,b){a?i.animate(k.container,"right",b):($("body").scrollTop(0),k.container.hide(),k.container.css("left","0px"),k.container.css("z-index","1")),$("#comment_input").val("")},c.exports=k}),define("webapp/bbs/1.0.0/subjectCreateView",["webapp/bbs/1.0.0/data","webapp/bbs/1.0.0/util"],function(a,b,c){var d=a("webapp/bbs/1.0.0/data"),e=a("webapp/bbs/1.0.0/util"),f={};f.container=$(".subject_creator_layer"),f.sendBtn=$("#send_subject"),f.subjectTitle=$("#subject_title"),f.subjectBody=$("#subject_body"),f.init=function(){f.parentRender=function(){history.back()},$(window).resize(function(){var a=$(this).height()+"px";f.container.css({height:a,"min-height":a})}),f.sendBtn.click(function(){var a=f.subjectTitle.val().trim(),b=f.subjectBody.val().trim();return a.length>30?(alert("对不起,您所发送的标题超长, 请您精简"),void 0):b.length>2048?(alert("对不起,您所发送的内容超长, 请您精简"),void 0):0==a.length?(alert("标题不能为空"),void 0):0==b.length?(alert("内容不能为空"),void 0):($(this).hasClass("progress")||($(this).addClass("progress"),d.addSubject({title:a,body:b},function(){f.sendBtn.removeClass("progress"),f.parentRender(!0)})),void 0)}),f.container.css("min-height",$(window).height()+"px")},f.render=function(){f.container.show()},f.dealloc=function(a,b){a?e.animate(f.container,"right",b):f.container.hide(),f.subjectTitle.val(""),f.subjectBody.val("")},c.exports=f}),define("webapp/bbs/1.0.0/messageListView",["webapp/bbs/1.0.0/data","webapp/bbs/1.0.0/util"],function(a,b,c){function d(a){var b='<li class="message_item" tid="{topic_id}" rid="{reply_id}"><div class="message_username">{username}</div><div class="message_content">{content}</div><div class="message_reply_topic">回复我的主题：{topic_title}</div><div class="message_reply_source">来自【{title}】 {timeStr}</div>',c=$(j(b,a));c.click(function(){var a=$(this).attr("tid"),b=h.getParams();location.href="comment.html"+b+"&tid="+a}),k.ulList.append(c)}function e(){l=0,$(".message_loadmore").hide(),h.getMessageList(l,function(a){k.ulList.empty(),d(a),$("#message_loadmore_btn").html("更多"),$(".message_loadmore").show()})}function f(a){h.getMessageList(++l,function(b){d(b),a.html("更多"),a.removeClass("loading"),0==b.length&&a.html("没有更多内容啦")})}function g(a){a&&e(),k.container.show(),k.backBtn.css("display","block"),k.refreshBtn.css("display","block")}var h=a("webapp/bbs/1.0.0/data"),i=a("webapp/bbs/1.0.0/util"),j=i.format,k={};c.exports=k,k.container=$(".message_list_view"),k.ulList=$("#message_list_ul"),k.backBtn=$("#message_back_btn"),k.refreshBtn=$("#message_refresh_btn");var l=0;k.init=function(){g(!0),$("#message_loadmore_btn").click(function(){var a=$(this);a.hasClass("loading")||(a.html("加载更多..."),a.addClass("loading"),f(a))}),k.refreshBtn.click(function(){e()})}});
