/*! 365 Calendar BBS 2015-05-26 */
function CommentListView(a,b){function c(b,c){if(h.scheduleTopicID=b.id,!h.bSchedule){var d='<li class="comment_header"><h3>{title}</h3><p>{body}</p><div class="image_container"></div><div class="comment_header_bottom"><a href="javascript:;" class="delete_subject_btn {deleteClass}" tid={id}>删除</a><span class="author">{username}</span><span class="re_time">{timeStr}</span><p class="reply_num">共{replyCount}楼</p></div></li>';if(h.ulList.append(g(d,b)),h.ulList.find(".delete_subject_btn").click(function(){var b=confirm("确定删除您所发表的主题？");b&&a.deleteSubject($(this).attr("tid"),function(){h.bSchedule?e():h.parentRender(!0)})}),c)for(var f in c)h.ulList.find(".image_container").append("<div class='image_div'><img src='"+c[f]+"' class='image_item'/></div>")}}function d(b,c){var e='<li class="comment_item comment_item_{id}"><div class="comment_username"><span class="louzhu hide">楼主</span>{username} :</div><div class="comment_txt">{replyUsername}{content}</div><div class="comment_item_bottom"><span>{timeStr}</span><a href="javascript:;" class="delete_comment_btn {deleteClass}" rid={id}>删除</a><a href="javascript:;" class="reply_btn" userid={userID} username={username} >回复</a></div></li>',f=$(g(e,b));c&&f.css("background","#fffcd7"),f.find(".delete_comment_btn").click(function(){var b=confirm("是否删除您的评论");if(b){var c=$(this).attr("rid");a.deleteComment(c,function(){h.ulList.find(".comment_item_"+c).remove()})}}),f.find(".reply_btn").click(function(){var b=$(this),c=b.parent().parent();if(c.find(".reply_comment_div").length>0)c.find(".reply_comment_div").remove(),b.html("回复");else{$(".comment_item .reply_btn").html("回复"),$(".comment_item .reply_comment_div").remove();var e=b.attr("userid"),f=b.attr("username");b.html("取消回复"),c.append("<div class='reply_comment_div'><div class='reply_input_div'><textarea type='text' class='reply_input' placeholder='回复 "+f+"'></textarea></div><a class='reply_send' href='javascript:;'>回复</a></div>"),c.find(".reply_send").click(function(){var f=$(this).parent().find(".reply_input").val().trim();if(0==f.length)return void alert("回复不能为空");if(f.length>1024)return void alert("回复内容超出限制");var g=$(this);$(this).hasClass("progress")||($(this).addClass("progress"),a.addComment({userID:e,content:f,topicID:h.topicID},function(a){g.removeClass("progress"),j=!0,c.find(".reply_comment_div").remove(),b.html("回复"),d(a,!0)},h.bSchedule))})}}),h.ulList.append(f)}function e(){$(".comment_edit_area").hide(),$(".comment_loadmore").hide(),h.ulList.html('<li class="preload_item" style="background: #ecedee;border:none;margin:200px auto;"><div class="loadbar"></div><div class="loadbar"></div><div class="loadbar"></div></li>'),a.initComment(h.topicID,function(b,e,f){h.ulList.empty(),i=0,c(b,f),d(e),e.length>=a.commentPageCount&&$(".comment_loadmore").show(),$("#comment_loadmore_btn").html("更多"),$(".comment_edit_area").show(),document.body.scrollHeight>screen.height?$(".comment_back_btn").show():$(".comment_back_btn").hide()},h.bSchedule,function(){h.ulList.html('<li style="text-align:center;height:100px;line-height:100px;">抱歉，此消息已被作者删除</li>')})}function f(b){var c=h.topicID;return h.bSchedule&&(c=h.scheduleTopicID),-1==c?void e():void a.getCommentList(c,++i,function(a){d(a),b.html("更多"),b.removeClass("loading"),0==a.length&&b.html("没有更多内容啦")})}var g=b.format,h={},i=0;h.ulList=$("#comment_list_ul"),h.container=$(".comment_list_view");var j=!1;return h.init=function(b){h.parentRender=function(){history.back()},h.bSchedule=b,$("#send_comment").click(function(){var c=$("#comment_input").val().trim();return 0==c.length?void alert("评论不能为空"):c.length>1024?void alert("评论内容超出限制"):void($(this).hasClass("progress")||($(this).addClass("progress"),a.addComment({userID:"-1",content:c,topicID:h.topicID},function(a){$("#send_comment").removeClass("progress"),j=!0,$("#comment_input").val(""),d(a,!0)},b)))}),$("#comment_loadmore_btn").click(function(){var a=$(this);a.hasClass("loading")||(a.html("加载更多..."),a.addClass("loading"),f(a))}),h.container.css("min-height",$(window).height()+"px"),$(".comment_back_btn").click(function(){$(this).hide(),$("#comment_input").focus()}),$(window).scroll(function(){$(window).scrollTop()+$(window).height()>=$(document).height()?$(".comment_back_btn").hide():0==$(window).scrollTop()&&$(".comment_back_btn").show()})},h.render=function(a){h.topicID=a,j=!1,e(),h.container.show(),location.href.indexOf("focus")>0&&setTimeout(function(){$("#comment_input").focus()},500)},h.dealloc=function(a,c){a?b.animate(h.container,"right",c):($("body").scrollTop(0),h.container.hide(),h.container.css("left","0px"),h.container.css("z-index","1")),$("#comment_input").val("")},h}function DataUtil(a){function b(b){var c=(new Date).getTime()-b,d=new Date(b),e=a.getDateZero(new Date).getTime()-a.getDateZero(d).getTime();return 6e4>c?"刚刚":c>=6e4&&36e5>c?Math.floor(c/6e4)+"分钟前":c>=36e5&&864e5>e?[("0"+d.getHours()).slice(-2),("0"+d.getMinutes()).slice(-2)].join(":"):e>=864e5&&2592e6>e?Math.floor(e/864e5)+"天前":[d.getFullYear(),("0"+(d.getMonth()+1)).slice(-2),("0"+d.getDate()).slice(-2)].join("-")}function c(b){0==b.type?(b.excellent="hide",b.no_excellent="show"):(b.excellent="show",b.no_excellent="hide"),0==b.state?(b.top="hide",b.notice="hide",b.no_top="show",b.no_notice="show"):1==b.state?(b.top="show",b.notice="hide",b.no_top="hide",b.no_notice="show"):(b.top="hide",b.notice="show",b.no_top="show",b.no_notice="hide"),b.title=a.encodeHtml(b.title),b.body=a.encodeHtml(b.body)}function d(a){return $.map(a,function(a){return 0==a.scheduleID?a.body.length>50&&(a.body=a.body.substr(0,50)+"..."):a.body="",c(a),a.timeStr=b(a.lastReplyTime),a.admin="true"==A?"show":"hide",a})}function e(c){return c?$.map(c,function(c){return c.timeStr=b(c.created),c.lz=c.userID==B.userID?"show":"hide",c.floor=++C,-1!=c.reply_user_id&&(c.replyUsername="回复 "+c.replyUsername+"："),c.deleteClass=c.userID==u||"true"==A?"show":"hide",c.content=a.encodeHtml(c.content),c}):[]}function f(b,c){var d=setTimeout(function(){try{var b=a.getURLParameter("t")||a.getURLParameter("token")||"",d=(new Base64).decode(b);c(-1==d.indexOf("%")?{Authorization:"Basic "+a.getURLParameter("t")}:{"x-365rili-key":a.getURLParameter("t")})}catch(e){c({})}},500);try{app.call({action:"getEncryptHeaders",params:[{name:"url",value:b}],callback:function(a){try{clearTimeout(d)}catch(b){}a=JSON.parse(a),c(a)}})}catch(e){try{app.call({action:"getToken",callBack:function(a){try{clearTimeout(d)}catch(b){}var e={"x-365rili-key":a};c(e)}})}catch(e){}}}function g(a){var b="http://www.365rili.com/bbs365/getTopicList.do?calendarID="+s+"&pageNum=0&pageCount="+y.subjectPageCount+"&token="+t+"&nocache="+z+x;f(b,function(c){$.ajax({url:b,type:"get",dataType:"json",headers:c,success:function(b){a(b)}})})}function h(a,b){var c="http://www.365rili.com/bbs365/getMoreTopics.do?calendarID="+s+"&pageNum="+a+"&pageCount="+y.subjectPageCount+"&token="+t+"&nocache="+z+x;f(c,function(a){$.ajax({url:c,type:"get",dataType:"json",headers:a,success:function(a){b(a)}})})}function i(a,b){var c="http://www.365rili.com/bbs365/getReplyList.do?topicID="+a+"&pageNum=0&pageCount="+y.commentPageCount+"&token="+t+"&nocache="+z+x;f(c,function(a){$.ajax({url:c,type:"get",dataType:"json",headers:a,success:function(a){b(a)}})})}function j(a,b,c){var d="http://www.365rili.com/bbs365/getMoreReplies.do?topicID="+a+"&pageNum="+b+"&pageCount="+y.commentPageCount+"&token="+t+"&nocache="+z+x;f(d,function(a){$.ajax({url:d,type:"get",dataType:"json",headers:a,success:function(a){c(a)}})})}function k(a,b){var c="http://www.365rili.com/bbs365/getTopicBySchedule.do?calendarID="+s+"&uuid="+a+"&pageNum=0&pageCount="+y.commentPageCount+"&token="+t+"&nocache="+z+x;f(c,function(a){$.ajax({url:c,type:"get",dataType:"json",headers:a,success:function(a){b(a)}})})}function l(a,b,c){var d="http://www.365rili.com/bbs365/postTopic.do";f(d,function(e){$.ajax({url:d,type:"post",dataType:"json",headers:e,data:{calendarID:s,title:a,body:b,token:t,"coco-ua":w},success:function(a){c(a)}})})}function m(a,b,c,d,e){var g="http://www.365rili.com/bbs365/postReply.do";f(g,function(f){$.ajax({url:g,type:"post",dataType:"json",headers:f,data:{replyUserID:a,content:b,topicID:c,token:t,"coco-ua":w},success:function(a){d(a)},error:e,timeout:1e4})})}function n(a,b,c,d,e){var g="http://www.365rili.com/bbs365/postReplyBySchedule.do";f(g,function(f){$.ajax({url:g,type:"post",dataType:"json",headers:f,data:{replyUserID:a,content:b,uuid:c,token:t,calendarID:s,"coco-ua":w},success:function(a){d(a)},error:e,timeout:1e4})})}function o(a,b){var c="http://www.365rili.com/bbs365/deleteTopic.do?topicID="+a+"&token="+t+x;f(c,function(a){$.ajax({url:c,type:"get",dataType:"json",headers:a,success:function(a){b(a)}})})}function p(a,b){var c="http://www.365rili.com/bbs365/deleteReply.do?replyID="+a+"&token="+t+x;f(c,function(a){$.ajax({url:c,type:"get",dataType:"json",headers:a,success:function(a){b(a)}})})}function q(a,b,c){var d="http://www.365rili.com/bbs365/topicAdmin.do?topicID="+a+"&action="+b+"&token="+t+x;f(d,function(a){$.ajax({url:d,type:"get",dataType:"json",headers:a,success:function(a){c(a)}})})}function r(a,b){var c="http://www.365rili.com/bbs365/getMyReplies.do?pageNum="+a+"&pageCount="+y.commentPageCount+"&token="+t+"&nocache="+z+x;f(c,function(a){$.ajax({url:c,type:"get",dataType:"json",headers:a,success:function(a){b(a)}})})}var s,t,u,v,w,x,y={},z=(new Date).getTime(),A=a.getURLParameter("admin");"true"==A&&($(".comment_btn_wrapper").show(),$(".comment_back_btn").click(function(){history.back()})),location.href.indexOf("?dev")>0?(s="427",t="MjQ2OjExMTExMQ==",u="246",v=(new Date).getTime()):(s=a.getURLParameter("cid"),app.getUa.android||(t=a.getURLParameter("t")),u=a.getURLParameter("uid"),v=a.getURLParameter("i"),location.href.indexOf("coco-ua")>0?(w=a.getURLParameter("coco-ua"),x="&coco-ua="+encodeURIComponent(w)):(w="",x="")),y.subjectPageCount=20,y.commentPageCount=100;var B={},C=1;return y.initSubject=function(a){g(function(b){"ok"==b.state&&a(b.calendarInfo,d(b.specialTopics.concat(b.topics)))})},y.getSubjectList=function(a,b){h(a,function(a){"ok"==a.state&&b(d(a.topics))})},y.addSubject=function(a,b){$("#loading_wrapper").show();var c=(new Date).getTime();l(a.title,a.body,function(a){if("ok"==a.state){var d=(new Date).getTime()-c;1e3>d?setTimeout(function(){$("#loading_wrapper").hide(),b(a)},1e3-d):($("#loading_wrapper").hide(),b(a))}})},y.deleteSubject=function(a,b){o(a,function(a){"ok"==a.state&&b(a)})},y.initComment=function(b,d,f,g){var h=i;f&&(h=k),h(b,function(b){"ok"==b.state?(B=b.topic,b.topic.timeStr=a.formatDate(b.topic.created),C=1,b.topic.floor=C,b.topic.replyCount++,b.topic.deleteClass=b.topic.userID==u&&-1!=b.topic.id||"true"==A?"show":"hide",c(b.topic),d(b.topic,e(b.replyList),b.piclist)):"failed"==b.state&&g()})},y.getCommentList=function(a,b,c){j(a,b,function(a){c(e(a.replyList))})},y.addComment=function(a,b,c){var d=m;c&&(d=n),$("#loading_wrapper").show();var f=(new Date).getTime();d(a.userID,a.content,a.topicID,function(a){if("ok"==a.state){var c=(new Date).getTime()-f;1e3>c?setTimeout(function(){$("#loading_wrapper").hide(),b(e([a.reply]))},1e3-c):($("#loading_wrapper").hide(),b(e([a.reply])))}},function(){$("#loading_wrapper").html("<div class='loading_error'>回复失败，请刷新后重试</div>"),setTimeout(function(){$("#loading_wrapper").html("").fadeOut("fast")},2e3)})},y.deleteComment=function(a,b){p(a,function(a){"ok"==a.state&&b(a)})},y.manageTopic=function(a,b,c){q(a,b,function(a){"ok"==a.state&&c(a)})},y.getMessageList=function(b,c){r(b,function(b){c($.map(b,function(b){return b.timeStr=a.formatDate(b.created),b}))})},y.getParams=function(){return["?cid=",s,"&uid=",u,"&t=",t,"&i=",v,x].join("")},y}function main(a){var b=Util(),c=DataUtil(b),d=CommentListView(c,b),e=SubjectCreateView(c,b),f=SubjectListView(c,b,d,e),g=MessageListView(c,b);if("subject_list"==a)f.init();else if("comment_list"==a)if(location.href.indexOf("uuid")>0){d.init(!0);var h=b.getURLParameter("uuid");d.render(h)}else{d.init(!1);var i=b.getURLParameter("tid");d.render(i)}else"subject_create"==a?e.init():"message_list"==a&&g.init()}function MessageListView(a,b){function c(b){var c='<li class="message_item" tid="{topic_id}" rid="{reply_id}"><div class="message_username">{username}</div><div class="message_content">{content}</div><div class="message_reply_topic">回复我的主题：{topic_title}</div><div class="message_reply_source">来自【{title}】 {timeStr}</div>',d=$(g(c,b));d.click(function(){var b=$(this).attr("tid"),c=a.getParams();location.href="comment.html"+c+"&tid="+b}),h.ulList.append(d)}function d(){i=0,$(".message_loadmore").hide(),a.getMessageList(i,function(a){h.ulList.empty(),c(a),$("#message_loadmore_btn").html("更多"),$(".message_loadmore").show()})}function e(b){a.getMessageList(++i,function(a){c(a),b.html("更多"),b.removeClass("loading"),0==a.length&&b.html("没有更多内容啦")})}function f(a){a&&d(),h.container.show(),h.backBtn.css("display","block"),h.refreshBtn.css("display","block")}var g=b.format,h={};h.container=$(".message_list_view"),h.ulList=$("#message_list_ul"),h.backBtn=$("#message_back_btn"),h.refreshBtn=$("#message_refresh_btn");var i=0;return h.init=function(){f(!0),$("#message_loadmore_btn").click(function(){var a=$(this);a.hasClass("loading")||(a.html("加载更多..."),a.addClass("loading"),e(a))}),h.refreshBtn.click(function(){d()})},h}function SubjectCreateView(a,b){var c={};return c.container=$(".subject_creator_layer"),c.sendBtn=$("#send_subject"),c.subjectTitle=$("#subject_title"),c.subjectBody=$("#subject_body"),c.init=function(){c.parentRender=function(){history.back()},$(window).resize(function(){var a=$(this).height()+"px";c.container.css({height:a,"min-height":a})}),c.sendBtn.click(function(){var b=c.subjectTitle.val().trim(),d=c.subjectBody.val().trim();return b.length>30?void alert("对不起,您所发送的标题超长, 请您精简"):d.length>2048?void alert("对不起,您所发送的内容超长, 请您精简"):0==b.length?void alert("标题不能为空"):0==d.length?void alert("内容不能为空"):void($(this).hasClass("progress")||($(this).addClass("progress"),a.addSubject({title:b,body:d},function(){c.sendBtn.removeClass("progress"),c.parentRender(!0)})))}),c.container.css("min-height",$(window).height()+"px")},c.render=function(){c.container.show()},c.dealloc=function(a,d){a?b.animate(c.container,"right",d):c.container.hide(),c.subjectTitle.val(""),c.subjectBody.val("")},c}function SubjectListView(a,b,c,d){function e(a){var b='<li class="subject_header e_clear"><div class="cal_img_border"><div class="cal_img"><img src="{thumb}" /></div></div><div class="cal_info"><h3>{title}</h3><p>话题：{topicCount}</p></div></li>';m.ulList.append(l(b,a)),$(".header_title").html(a.title)}function f(b){var c='<li class="subject_item" tid="{id}"><h3><span class="top {top}">置顶</span><span class="notice {notice}">公告</span><span class="excellent {excellent}">精华</span>{title}</h3><p>{body}</p><div class="subject_list_bottom e_clear"><span class="re_time">{timeStr}</span><span class="com_num">{replyCount}</span><span class="author">{username}</span></div><div class="{admin}"><button class="manage_action {no_top}" val="3">置顶</button><button class="manage_action {top}" val="6">取消置顶</button><button class="manage_action {no_notice}" val="2">公告</button><button class="manage_action {notice}" val="5">取消公告</button><button class="manage_action {no_excellent}" val="1">精华</button><button class="manage_action {excellent}" val="4">取消精华</button></div></li>',d=$(l(c,b));d.click(function(){var a=$(this).attr("tid");m.scrollTop=document.body.scrollTop,k(!1,m.clView.container),location.href="#clView="+a,m.clView.render(a,!0)}),d.find(".manage_action").click(function(b){b.stopPropagation(),b.preventDefault();var c=$(this).parent().parent(),d=c.attr("tid"),e=$(this).attr("val");a.manageTopic(d,e,function(){g()})}),m.ulList.append(d)}function g(){$(".more_btn_wrapper").hide(),$(".create_btn_wrapper").hide(),a.initSubject(function(b,c){m.ulList.empty(),n=0,e(b),f(c),c.length>=a.subjectPageCount?$(".more_btn_wrapper").show():m.ulList.css("margin-bottom","60px"),$("#subject_loadmore_btn").html("更多"),$(".create_btn_wrapper").show()})}function h(b){a.getSubjectList(++n,function(a){f(a),b.html("更多"),b.removeClass("loading"),0==a.length&&b.html("没有更多内容啦")})}function i(){if(m.clView=c,m.scView=d,m.clView.init(!1),m.scView.init(),location.hash.indexOf("scView")>-1)k(!1),m.scView.render();else if(location.hash.indexOf("clView")>-1){var a=location.hash.split("=")[1];k(!1),m.clView.render(a)}else j(!0);$("#subject_loadmore_btn").click(function(){var a=$(this);a.hasClass("loading")||(a.html("加载更多..."),a.addClass("loading"),h(a))}),m.createBtn.click(function(){k(!1,m.scView.container),location.href="#scView",m.scView.render()}),m.refreshBtn.click(function(){g()}),window.addEventListener("hashchange",function(a){-1==a.newURL.indexOf("#")&&(a.oldURL.indexOf("#scView")>-1?(m.scView.dealloc(!1,m.container),j(!0)):(m.clView.dealloc(!1,m.container),j(!0)))},!1),m.container.css("min-height",$(window).height()+"px")}function j(a){a&&g(),m.container.show(),m.backBtn.css("display","block"),m.createBtn.css("display","block"),m.refreshBtn.css("display","block"),m.scrollTop&&(document.body.scrollTop=m.scrollTop)}function k(a,c){a?b.animate(m.container,"left",c):($("body").scrollTop(0),m.container.hide()),m.backBtn.hide(),m.createBtn.hide(),m.refreshBtn.hide()}var l=b.format,m={};m.container=$(".subject_list_view"),m.ulList=$("#subject_list_ul"),m.backBtn=$("#subject_back_btn"),m.createBtn=$("#create_subject_btn"),m.refreshBtn=$("#subject_refresh_btn");var n=0;return m.init=i,m}function Util(){var a,b={};return b.format=function(){var b=String(arguments[0]||""),c=arguments[1],d=[],e=$.isArray(c)?c:[c];return $.each(e,function(c,e){d.push(b.replace(a||(a=/\{([\d\w\.]+)\}/g),function(a,b,d){return d="INDEX"===b?c:b.indexOf(".")<0?e[b]:$.route(e,b),void 0===d?a:$.isFunction(d)?d.call(e,b):d}))}),d.join("")},b.formatDate=function(a){var b=new Date(a),c=[b.getFullYear(),("0"+(b.getMonth()+1)).slice(-2),("0"+b.getDate()).slice(-2)].join("-"),d=[("0"+b.getHours()).slice(-2),("0"+b.getMinutes()).slice(-2)].join(":");return c+" "+d},b.bIsAndroid=function(){var a=navigator.userAgent.toLowerCase();return"android"==a.match(/android/i)},b.getURLParameter=function(a){return decodeURIComponent((new RegExp("[?|&]"+a+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},b.getDateZero=function(a){var b=new Date(a);return b.setHours(0),b.setMinutes(0),b.setSeconds(0),b.setMilliseconds(0),b},b.encodeHtml=function(a){var b="";return 0==a.length?"":(b=a.replace(/&/g,"&amp;"),b=b.replace(/</g,"&lt;"),b=b.replace(/>/g,"&gt;"),b=b.replace(/ /g,"&nbsp;"),b=b.replace(/\'/g,"&#39;"),b=b.replace(/\"/g,"&quot;"),b=b.replace(/\n/g,"<br>"))},b.animate=function(a,b){var c=$(window).width();$("body").scrollTop(0),a.css("z-index","11"),a.one("webkitTransitionEnd",function(){$(this).hide(),$(this).css("left","0px"),$(this).css("z-index","1")}),"left"==b?a.css("left","-"+c+"px"):a.css("left",c+"px")},b}