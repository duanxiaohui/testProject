define(["zepto","util","/third_cooperation/qqgroup/js/appData.js","/third_cooperation/qqgroup/js/schedule.js","/js/lib/DatePicker_1/DateTimePicker.js"],function(f,b,d,e){var a=new Date();a.setHours(a.getHours()+1,0,0);window.sch=e;window.__data={};return{create:function(t){var u=new Date(JSON.parse(window.name).date);f(".scheduleMain").html('<form id="createScheduleForm" onsubmit="return false;">	    		<div class="panel scheduleIconSet">	    			<table>	    				<tr>	    					<td>	    						<a data-icon="birthday" href="javascript:;"></a>	    					</td>	    					<td>	    						<a data-icon="study" href="javascript:;"></a>	    					</td>	    					<td>	    						<a data-icon="game" href="javascript:;"></a>	    					</td>	    					<td>	    						<a data-icon="0" href="javascript:;"><img src="/third_cooperation/qqgroup/images/scheduleIcon/create_more.png" width="50" alt="" /></a>	    					</td>	    				</tr>	    			</table>	    			<div class="line"></div>	    			<textarea rows=1 type="text" placeholder="记下和群里有关的事情" class="schtitle" id="title"></textarea>	    		</div>	    		<div class="panel e_clear">	    			<div class="checkBox">	    				<input id="allday" class="ios7CBox" type="checkbox">	    			</div>	    			<label for="allday">是否创建全天日程</label>	    			<div class="line"></div>					<div class="beginDate setDate">						<label for="beginDate">开始时间</label>						<em></em>						<input type="text" data-field="datetime" readonly id="beginDate">					</div>					<div class="endDate setDate">						<label>结束时间</label>						<em></em>						<input type="text" data-field="datetime" readonly id="endDate">					</div>	    		</div>	    		<div class="panel">	    			<p class="tip tpTip">提醒<span class="tipState">展开</span></p>	    			<div class="line"></div>	    			<div class="timePoint nall e_clear">	    				<span class="nopoint" data-point="-1">不提醒</span><span class="point allday" data-point="0">正点</span><span class="point noAllday" data-point="10">10分钟前</span><span class="point allday" data-point="1440">1天前</span><span class="point noAllday" data-point="5">5分钟前</span><span class="point noAllday" data-point="30">30分钟前</span><span class="point noAllday" data-point="60">1小时前</span><span class="point allday" data-point="4320">3天前</span>	    			</div>	    			<div class="timePointTxt">	    				<p class="noTPT">未设置任何提醒</p>	    			</div>	    		</div>	    		<div class="panel">	    			<p class="tip reTip"><em>不重复</em><span class="tipState"></span></p>	    			<div class="repeatSet e_clear">	    				<div class="line reLine"></div>	    				<div>	    					<span class="point" data-point="0">不重复</span><span class="point" data-point="1">每天</span><span class="point" data-point="7">每周(周'+["日","一","二","三","四","五","六"][u.getDay()]+')</span><span class="point" data-point="31">每月('+u.getDate()+'日)</span><span class="point" data-point="365">每年('+(u.getMonth()+1)+"月"+u.getDate()+'日)</span>	    				</div>	    			</div>	    		</div>	    		<div class="saveBtn control btn">	    			<button type="submit">保存日程</button>	    		</div>	    	</form>');f(".timePoint").on("tap",".point",r);f(".repeatSet").on("tap",".point",h);f(".scheduleIconSet a").on("tap",i);f(".tpTip").on("tap",j);f(".reTip").on("tap",function(){f(this).parent().toggleClass("show");});f("<div id='dtBox'></div>").appendTo("body").DateTimePicker({init:function(){__data.dtBegin=this;},settingValueOfElement:function(z,A,B){m(z,"beginDate");f("#endDate").data("min",z);if(f(".endDate em").html()=="尚未设置"){f("#endDate").val(z);}},dateTimeFormat:"yyyy-MM-dd hh:mm",parentElement:".beginDate",titleContentDateTime:"设置开始时间",buttonsToDisplay:["HeaderCloseButton","SetButton"]});f("<div id='dtBox1'></div>").appendTo("body").DateTimePicker({init:function(){__data.dtEnd=this;},settingValueOfElement:function(z,B,C){m(z,"endDate");f("#beginDate").data("max",z);if(z==""){if(f("#allday").prop("checked")){f(C).val(f("#beginDate").val());}else{var A=new Date(f("#beginDate").val().replace(/-/g,"/"));A.setHours(A.getHours+1);f(C).val(__data.dtBegin.getDateTimeStringInFormat("datetime",""));}}},buttonClicked:function(A,z){if(A=="CLEAR"){m("","endDate");f("#beginDate").data("max","");}},dateTimeFormat:"yyyy-MM-dd hh:mm",parentElement:".endDate",titleContentDateTime:"设置结束时间",buttonsToDisplay:["HeaderCloseButton","SetButton","ClearButton"]});f(".nopoint").on("tap",x);f("#allday").on("change",function(){if(this.checked){var C=f("#beginDate").val();var E=f("#endDate").val();f("#beginDate").data("field","date");f("#endDate").data("field","date");var z=E.split(" ")[0];var D=C.split(" ")[0];f("#beginDate").val(D);m(D,"beginDate");if(f(".endDate em").html()=="尚未设置"){f("#endDate").val(D);m("","endDate");}else{f("#endDate").val(z);m(z,"endDate");}f(".noAllday").addClass("none");f(".noAllday.on").each(function(F,G){r.call(f(G));});f(".allday.on").each(function(F,G){r.call(f(G));r.call(f(G));});f('.timePoint .point[data-point="0"]').hasClass("on")||r.call(f('.timePoint .point[data-point="0"]'));f(".tipState").addClass("none");f(".tpTip").off("tap",j);f(".tpTip").parent().removeClass("show");f(".tipState").html("展开");f(".timePoint").addClass("all");f(".timePoint").removeClass("nall");}else{var B=new Date();B.setHours(B.getHours()+1,0,0);var A=new Date(B);A.setHours(A.getHours()+1,0,0);var C=f("#beginDate").val();var D=C+" "+q(B);var E=f("#endDate").val();var z=E+" "+q(A);f("#beginDate").data("field","datetime");f("#endDate").data("field","datetime");f("#beginDate").val(D);f("#endDate").val(z);if(f(".endDate em").html()=="尚未设置"){z="";}m(D,"beginDate");m(z,"endDate");f(".noAllday").removeClass("none");f(".on").each(function(F,G){r.call(f(G));r.call(f(G));});f(".tipState").removeClass("none");f(".tpTip").on("tap",j);if(f('.timePoint .point[data-point="4320"]').hasClass("on")){f(".tpTip").parent().addClass("show");f(".tipState").html("收起");}f(".timePoint").removeClass("all");f(".timePoint").addClass("nall");}});f("#title").on("input",l);s();var n=b.query("cid");f("#createScheduleForm").on("submit",v);function k(D){D=D||f("#beginDate")[0];var B=new Date(f("#beginDate").val());var z=new Date(f("#endDate").val());if(z<B){plug.alert("","结束时间不能小于开始时间");if(D.type=="datetime-local"){var C=new Date(f("#beginDate").val().replace(/-/g,"/").replace("T"," "));C.setHours(C.getHours()+1,0,0);var A=y(C);f("#endDate").val(A);m(A,"endDate");}else{var C=new Date(f("#beginDate").val().replace(/-/g,"/").replace("T"," "));C.setHours(C.getHours()+1,0,0);var A=y(C);f("#endDate").val(A);m(A,"endDate");}f(D).blur();return false;}if(z-B.setYear(B.getFullYear()+50)>0){plug.alert("","结束时间不能大于开始时间50年");if(D.type=="datetime-local"){var C=new Date(f("#beginDate").val().replace(/-/g,"/").replace("T"," "));C.setHours(C.getHours()+1,0,0);var A=y(C);f("#endDate").val(A);m(A,"endDate");}else{var C=new Date(f("#beginDate").val().replace(/-/g,"/").replace("T"," "));C.setHours(C.getHours()+1,0,0);var A=y(C);f("#endDate").val(A);m(A,"endDate");}f(D).blur();return false;}return true;}function v(){window.isCheckData=true;f(".saveBtn button").attr("disabled",true);var D={schTitle:"",alldayEvent:"",calendarId:"",startTime:"",duration:"",before_minutes:"",scheduleId:"",};if(t){D.scheduleId=t.sid;D.calendarId=t.calendarId;}else{D.calendarId=n;}D.schTitle=f.trim(f("#title").val());var C=f(".timePoint .on");if(C.length==1&&C.hasClass("nopoint")){D.before_minutes="";}else{var F=[];C.each(function(G,H){F.push(f(H).data("point")).toString();});D.before_minutes=F.join(",");}D.fromDate="1970-01-01";D.toDate="1970-01-01";var B=new Date(f("#beginDate").val().replace("T"," ").replace(/-/g,"/"));D.startTime=w(B)+":00";var E=f("#endDate").val();if(!E){D.duration=0;}else{E=new Date(E.replace(/-/g,"/"));D.duration=(E.getTime()-B.getTime())/1000;}console.log(E.getTime(),B.getTime());return false;D.alldayEvent=f("#allday").prop("checked").toString();if(D.alldayEvent=="true"){B.setHours(9);D.startTime=w(B)+":00";}if(D.schTitle==""){plug.alert("","请填写日程内容");f(".saveBtn button").prop("disabled",false);return false;}var z=f(".repeatSet .on").data("point");D.repeatType=z;D.repeatFrequency=1;switch(z){case 0:case 1:D.repeatDay="";D.repeatMonth="";D.repeatMonthDay="";break;case 7:D.repeatDay="SUN MON TUE WED THU FRI SAT".split(" ")[B.getDay()];D.repeatMonth="";D.repeatMonthDay="";break;case 31:D.repeatDay="";D.repeatMonth="";D.repeatMonthDay=B.getDate();break;case 365:D.repeatDay="";D.repeatMonth=B.getMonth();D.repeatMonthDay=B.getDate();break;}D.extend=D.extend||{};D.extend.point=f(".scheduleIconSet a.on").data("icon");D.extend.point||(delete D.extend.point);D.extend=JSON.stringify(D.extend);if(!k()){f(".saveBtn button").prop("disabled",false);return false;}D.repeatStopTime="";D.repeatCount="";f(".saveBtn button").html("保存中...");var A=c("auto").split("%")[0];D.updateV2Origin="18";f.ajax({url:"/schedule/mobileQQUpdateV2.do",data:D,type:"post",success:function(G){if(G.state=="ok"){var H={scheduleID:G.sid,action:""};if(t){H.action="U";}else{H.action="A";}f.ajax({url:"/mobile-qqun/sendGroupMsg.do",data:H});f.ajax({url:"/schedule/getQQSchedule.do",data:{cid:n,uuid:G.uuid,t:+new Date},success:function(I){I.schedule.sid=G.sid;window.sch.initSchedule(I);}});return false;}plug.alert("","日程保存失败");f(".saveBtn button").prop("disabled",false).html("保存日程");},error:function(){plug.alert("","日程保存失败");f(".saveBtn button").prop("disabled",false).html("保存日程");}});}function s(){if(t){document.title="日程编辑";var E=t.title||t.schTitle;E=E.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&nbsp;/g," ").replace(/&#39;/g,"'").replace(/&quot;/g,'"');l.call(f("#title").val(E)[0]);var A;if(typeof t.startTime=="number"){A=new Date(t.startTime);}else{A=new Date(t.startTime.replace(/-/g,"/"));}var z=__data.dtBegin.getDateTimeStringInFormat("datetime","yyyy-MM-dd hh:mm",A);f("#beginDate, #endDate").val(z);m(z,"beginDate");var I="";if(t.duration){var C=new Date(A.getTime()+t.duration*1000);I=__data.dtBegin.getDateTimeStringInFormat("datetime","yyyy-MM-dd hh:mm",C);f("#endDate").val(I);}m(I,"endDate");t.alldayEvent=t.alldayEvent||t.allDayEvent;t.alldayEvent=t.alldayEvent.toString()=="true";if(t.alldayEvent){f("#allday").prop("checked",t.alldayEvent);var A;if(typeof t.startTime=="number"){A=new Date(t.startTime);}else{A=new Date(t.startTime.replace(/-/g,"/"));}var C=y(new Date(A.getTime()+t.duration*1000)).split("T")[0];A=y(A).split("T")[0];f("#beginDate").data("field","date");f("#endDate").data("field","date");f("#beginDate").val(A);f("#endDate").val(C);m(A,"beginDate");m(C,"endDate");f(".tipState").addClass("none");f(".tpTip").off("tap",j).parent().removeClass("show");f(".timePoint").addClass("all").removeClass("nall");f(".noAllday").addClass("none");}var F=t.before_minutes||t.alarm||"";F=F.toString();if(F==""){x();}else{F=F.split(",");for(var B=0;B<F.length;B++){r.call(f('.point[data-point="'+F[B]+'"]'));}if(!t.alldayEvent){f(".tpTip .tipState").html("收起");f(".tpTip, .reTip").parent().addClass("show");f(".timePoint").addClass("nall").removeClass("all");}}t.extend&&(t.extend=JSON.parse(t.extend));f('.scheduleIconSet a[data-icon="'+t.extend.point+'"]').addClass("on");var H=t.repeatType;h.call(f('.repeatSet .point[data-point="'+H+'"]'));g();}else{var D=d.get("date");var A=new Date();if(D){var G=new Date(D);A.setDate(1);A.setYear(G.getFullYear());A.setMonth(G.getMonth());A.setDate(G.getDate());}A.setHours(A.getHours()+1,0,0);var z=__data.dtBegin.getDateTimeStringInFormat("datetime","yyyy-MM-dd hh:mm",new Date(A));f("#beginDate, #endDate").val(z);m(z,"beginDate");m("","endDate");f("#endDate").data("min",z);r.call(f('.timePoint .point[data-point="10"]'));h.call(f(".repeatSet .point:first"));}}function l(){if(this.value.length>1000){this.value=this.value.substr(0,1000);}var E=this.value.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>");var D=f(this);if(f.trim(this.value).length<=0){this.value="";return D.height(21);}var B=f('<div class="checkheight"></div>');B.css({width:D.width(),"line-height":D.css("line-height"),"font-size":D.css("font-size"),"word-break":"break-all","font-family":"Microsoft YaHei",overflow:"hidden"});var A=this.value.replace(/&/g,"&amp;");A=A.replace(/</g,"&lt;");A=A.replace(/>/g,"&gt;");A=A.replace(/ /g,"&nbsp;");A=A.replace(/\'/g,"&#39;");A=A.replace(/\"/g,"&quot;");B.html(A.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>"));B.appendTo("body");var z=B.height()-1;var C=B.html().split("<br>");if(C.length>=2){z+=21;}B.remove();if(z<63){}if(D.height()!=z){D.height(z);}}function j(){var A=f(this).parent();var z=f(".tpTip .tipState");if(A.hasClass("show")){A.removeClass("show");z.html("展开");}else{A.addClass("show");z.html("收起");}}function m(z,A){if(!z){return f("."+A+" em").html("尚未设置");}z=z.replace("T"," ");f("."+A+" em").html(z);}function h(){var z=f(this);f(".repeatSet .point").removeClass("on");z.addClass("on");f(".reTip em").html(f(this).html());}function i(){var z=f(this);if(z.data("icon")==0){return plug.alert("","更多日程标识正在积极准备中，<br />敬请期待～");}f(".scheduleIconSet a").removeClass("on");z.addClass("on");}function g(){var z=new Date(f("#beginDate").val().replace("T"," ").replace(/-/g,"/"));var A=f(".repeatSet span");A.eq(2).html("每周(周"+["日","一","二","三","四","五","六"][z.getDay()]+")");A.eq(3).html("每月("+z.getDate()+"日)");A.eq(4).html("每年("+(z.getMonth()+1)+"月"+z.getDate()+"日)");f(".reTip em").html(f(".repeatSet .on").html());}window.refreshRepeat=g;function r(){var D=f(this);if(D.hasClass("on")){D.removeClass("on");}else{D.addClass("on");}f(".nopoint").removeClass("on");var B=new Date(f("#beginDate").val().replace("T"," ").replace(/-/g,"/"));var A=f(".timePoint .on");var z=[];var C=f("#allday").prop("checked");A.each(function(E,I){var H=f(I).data("point");var F=new Date(B);F.setMinutes(B.getMinutes()-H);var G="";switch(H.toString()){case"0":G="正点";break;case"5":G="提前5分钟";break;case"10":G="提前10分钟";break;case"30":G="提前30分钟";break;case"60":G="提前1小时";break;case"1440":G="提前1天";break;case"4320":G="提前3天";}z.push('<p data-point="'+H+'">'+G+"提醒：<span>"+(!C?w(F):(p(F)+" 09:00"))+"</span></p>");});f(".timePointTxt").html(z.join(""));if(z.length==0){x();}}function x(){f(".timePoint .on").removeClass("on");f(".nopoint").addClass("on");f(".timePointTxt").html('<p class="noTPT">未设置任何提醒</p>');}function o(z){}function y(z){return[z.getFullYear(),z.getMonth()+1,z.getDate()].join("-").replace(/(\D)(\d)(?=\D|$)/g,"$10$2")+"T"+["",z.getHours(),z.getMinutes()].join(":").replace(/(\D)(\d)(?=\D|$)/g,"$10$2").substr(1);}function q(z){return["",z.getHours(),z.getMinutes()].join(":").replace(/(\D)(\d)(?=\D|$)/g,"$10$2").substr(1);}function w(z){return[z.getFullYear(),z.getMonth()+1,z.getDate()].join("-").replace(/(\D)(\d)(?=\D|$)/g,"$10$2")+" "+["",z.getHours(),z.getMinutes()].join(":").replace(/(\D)(\d)(?=\D|$)/g,"$10$2").substr(1);}function p(z){return[z.getFullYear(),z.getMonth()+1,z.getDate()].join("-").replace(/(\D)(\d)(?=\D|$)/g,"$10$2");}}};function c(g){var l=null;if(document.cookie&&document.cookie!=""){var k=document.cookie.split(";");for(var j=0;j<k.length;j++){var h=k[j].replace(/^\s+|\s+$/g,"");if(h.substring(0,g.length+1)==(g+"=")){l=decodeURIComponent(h.substring(g.length+1));break;}}}return l;}});